<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="Form Input HM Pelatihan - Web App untuk pencatatan data pelatihan">
  <meta name="theme-color" content="#2e687b">
  <meta name="color-scheme" content="light dark">
  
  <!-- PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="HM Pelatihan">
  
  <!-- Manifest -->
  <link rel="manifest" href="/hm-pelatihan/manifest.json">
  <link rel="manifest" href="manifest.json">
  
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <title>Form Input HM Pelatihan</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(
      to bottom,
      #2e687bff,
      #00384d,
      #002b3d);
    }
    .container {
      max-width: 400px;
      margin: 10px auto;
      background: rgba(255, 255, 255, 0.4);
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h3 {
      text-align: center;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      margin-top: 20px;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    
    /* Tombol Biru */
    .btn-blue {
      background: #007bff;
    }
    button.btn-blue:hover {
      background: #0056b3;
    }
    
    /* Tombol Kuning */
    .btn-yellow {
      background-color: #ffc107;
      color: #000;
    }
    button.btn-yellow:hover {
      background-color: #e0a800;
    }
    .hidden {
      display: none;
    }
    
    /* Modal Styling */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-overlay.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 400px;
      position: relative;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .modal-header h4 {
      margin: 0;
      font-size: 18px;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-close:hover {
      color: #dc3545;
    }
    
    #editList {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    
    /* App Bar */
    .app-bar {
      background: linear-gradient(to right, #2e687b, #1a3d4d);
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .app-bar h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }
    
    .app-bar-right {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .btn-install {
      background: #ffc107;
      color: #000;
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      display: none;
    }
    
    .btn-install:hover {
      background: #e0a800;
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #4CAF50;
      margin-right: 8px;
      display: inline-block;
    }
    
    .status-indicator.offline {
      background: #f44336;
    }
    
    .offline-notice {
      background: #f44336;
      color: white;
      padding: 10px;
      text-align: center;
      font-size: 14px;
      display: none;
    }
    
    .offline-notice.show {
      display: block;
    }
  </style>
</head>
<body>
  <!-- App Bar -->
  <div class="app-bar">
    <div>
      <h1>Form Input HM Pelatihan</h1>
    </div>
    <div class="app-bar-right">
      <span class="status-indicator" id="statusIndicator"></span>
      <button class="btn-install" id="installBtn">Install App</button>
    </div>
  </div>

  <!-- Offline Notice -->
  <div class="offline-notice" id="offlineNotice">
    ðŸ”´ Mode Offline - Perubahan akan disimpan saat kembali online
  </div>

  <div class="container">

    <form id="inputForm">
      
      <label for="kelas">Kelas</label>
      <select id="kelas" required>
        <option value="" disabled selected hidden>-- Pilih Kelas --</option>
        <option value="221">Kelas 221</option>
        <option value="222">Kelas 222</option>
        <option value="223">Kelas 223</option>
        <option value="224">Kelas 224</option>
        <option value="225">Kelas 225</option>
        <option value="228">Kelas 228</option>
      </select>
      
      <div id="classIdContainer" class="hidden">
        <label for="classId">Class ID</label>
        <input
          type="text"
          id="classId"
          name="classId"
          readonly
          placeholder="Pilih Kelas Dulu !"
        >
      </div>

      <label for="nama">Nama</label>
      <input type="text" id="nama" name="nama" required placeholder="Masukan Nama Lengkap...">

      <label for="nrp">NRP</label>
      <input type="text" id="nrp" name="nrp" required placeholder="Masukan NRP...">

      <label for="tipeUnit">Tipe Unit</label>
      <select id="tipeUnit" name="tipeUnit" required>
        <option value="" disabled selected hidden>-- Pilih Tipe Unit --</option>
        <option value="HD 785-7">HD 785-7</option>
        <option value="CAT 777 D">CAT 777 D</option>
        <option value="CAT 777 E">CAT 777 E</option>
      </select>
      
      <label for="namaInstruktur">Nama Instruktur</label>
      <select id="namaInstruktur" name="namaInstruktur" required>
        <option value="" disabled selected hidden>-- Pilih Instruktur --</option>
        <option value="Adlin Zaid Ismail">Adlin Zaid Ismail</option>
        <option value="Asep Cahyadi">Asep Cahyadi</option>
        <option value="Ananto Ninggar Sejati">Ananto Ninggar Sejati</option>
        <option value="Anton Sersandi Wahyu">Anton Sersandi Wahyu</option>
        <option value="Budiman">Budiman</option>
        <option value="Herry Kiswanto Kanoneng">Herry Kiswanto Kanoneng</option>
        <option value="Khumaidi Noval">Khumaidi Noval</option>
        <option value="Mohamad Khoirul Umam">Mohamad Khoirul Umam</option>
        <option value="Muhammad Abdianoor">Muhammad Abdianoor</option>
        <option value="Muhammad Syaukani">Muhammad Syaukani</option>
        <option value="Naryono">Naryono</option>
        <option value="Ryan Pamungkas">Ryan Pamungkas</option>
        <option value="Slamet Herianto">Slamet Herianto</option>
        <option value="Teguh Arifiatna">Teguh Arifiatna</option>
        <option value="Wahyudi">Wahyudi</option>
        
      </select>
      
      <!-- Sub Utama -->
      <label for="tahapanPelatihan">Tahapan Pelatihan</label>
      <select id="tahapanPelatihan" name="tahapanPelatihan" required>
        <option value="" disabled selected hidden>-- Pilih Tahapan --</option>
        <option value="PENDAMPINGAN INSTRUKTUR SIMULATOR">PENDAMPINGAN INSTRUKTUR SIMULATOR</option>
        <option value="PENDAMPINGAN INSTRUKTUR UNIT">PENDAMPINGAN INSTRUKTUR UNIT</option>
        <option value="PENDAMPINGAN OPERATOR SIANG">PENDAMPINGAN OPERATOR SIANG</option>
        <option value="PENDAMPINGAN OPERATOR MALAM">PENDAMPINGAN OPERATOR MALAM</option>
        <option value="EAP REFRESH & COACHING COUNSELING">EAP REFRESH & COACHING COUNSELING</option>
        <option value="EAP LHD SIANG">EAP LHD SIANG</option>
        <option value="EAP LHD MALAM">EAP LHD MALAM</option>
        <option value="ORIENTASI MALAM">ORIENTASI MALAM</option>
        <option value="ORIENTASI UNIT LAIN">ORIENTASI UNIT LAIN</option>
      </select>
      
      <!-- Sub Tahapan -->
    <div id="subTahapanContainer" class="hidden">
      <label for="subTahapan">Aktivitas</label>
      <select id="subTahapan" name="subTahapan" required>
        <option value="">-- Pilih Aktivitas --</option>
      </select>
    </div>
    
      <label for="tanggal">Tanggal</label>
      <input type="date" id="tanggal" name="tanggal" required>
      
      <label for="cnUnit">C/N Unit</label>
      <input type="text" id="cnUnit" name="cnUnit" required placeholder="Masukan Kode Unit yang dioperasikan">
      
      <label for="lokasi">Lokasi</label>
      <input type="text" id="lokasi" name="lokasi" required placeholder="Lokasi Praktek">
      
      <label for="hmAwal">HM Awal</label>
      <input type="text" id="hmAwal" name="hmAwal"
        required placeholder="Gunakan tanda koma (,) untuk desimal"
        oninput="formatKoma(this);hitungTotalHM()">
      
      <label for="hmAkhir">HM Akhir</label>
      <input type="text" id="hmAkhir" name="hmAkhir"
        required placeholder="Gunakan tanda koma (,) untuk desimal"
        oninput="formatKoma(this); hitungTotalHM()">

      <label for="totalHM">Total HM</label>
      <input type="text"
             id="totalHM"
             name="totalHM"
             readonly
             placeholder="Otomatis Terisi">
      
      <label for="keterangan">Keterangan</label>
      <input type="text" id="keterangan" name="keterangan" placeholder=" Diisi keterangan saat standby atau ada kendala saat pelatihan">
      
      <button type="submit" class="btn-blue">Kirim</button>
      <button type="button" class="btn-yellow" id="editBtn">Edit</button>
    </form>
  </div>

  <!-- Modal Edit Selector -->
  <div id="editSelector" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h4>Pilih Data yang Akan Diedit</h4>
        <button type="button" class="modal-close" id="closeEditModal">&times;</button>
      </div>
      <select id="editList"></select>
    </div>
  </div>

<script>
function formatKoma(el) {
    // Hanya izinkan angka dan koma
    el.value = el.value
      .replace(/\./g, ',')        // ubah titik jadi koma
      .replace(/[^0-9,]/g, '')      // hapus selain angka & koma
      .replace(/,(?=.*,)/g, '');    // hanya 1 koma
}
 function hitungTotalHM() {
    const hmAwal = document.getElementById('hmAwal').value.replace(',', '.');
    const hmAkhir = document.getElementById('hmAkhir').value.replace(',', '.');
    const totalHMInput = document.getElementById('totalHM');
  
    if (hmAwal !== '' && hmAkhir !== '') {
      const awal = parseFloat(hmAwal);
      const akhir = parseFloat(hmAkhir);
  
      if (!isNaN(awal) && !isNaN(akhir)) {
        const total = akhir - awal;
  
        // tampilkan kembali pakai koma
        totalHMInput.value = total.toFixed(1).replace('.', ',');
      } else {
        totalHMInput.value = '';
      }
    } else {
      totalHMInput.value = '';
    }
 }

/* ================== GLOBAL ================== */
const form = document.getElementById('inputForm');
const submitBtn = document.querySelector('.btn-blue');
const editBtn = document.getElementById('editBtn');

const tahapanSelect = document.getElementById('tahapanPelatihan');
const subTahapanContainer = document.getElementById('subTahapanContainer');
const subTahapanSelect = document.getElementById('subTahapan');

const kelasSelect = document.getElementById('kelas');
const classIdInput = document.getElementById('classId');
const classIdContainer = document.getElementById('classIdContainer');

const editSelector = document.getElementById('editSelector');
const editList = document.getElementById('editList');

let isEditMode = false;
let editRow = null;

/* ================== MAPPING ================== */
const subTahapanData = {
  'PENDAMPINGAN INSTRUKTUR SIMULATOR': ['PENGENALAN KOMPONEN UTAMA & P2H', 'MAJU & MUNDUR LETTER I', 'MAJU & MUNDUR LETTER L/T', 'ZIG-ZAG', 'TRAVEL KOSONGAN', 'MANUVER', 'LOADING-HAULING-DUMPING', 'DEFENSIVE & RESPONSIBLE TRAINING'],
  'PENDAMPINGAN INSTRUKTUR UNIT': ['PENGENALAN KOMPONEN UTAMA & P2H', 'MAJU & MUNDUR LETTER I', 'MAJU & MUNDUR LETTER L/T', 'ZIG-ZAG', 'TRAVEL KOSONGAN', 'MANUVER', 'LOADING-HAULING-DUMPING', 'DEFENSIVE & RESPONSIBLE TRAINING'],
  'PENDAMPINGAN OPERATOR SIANG': ['LOADING-HAULING-DUMPING SIANG'],
  'PENDAMPINGAN OPERATOR MALAM': ['LOADING-HAULING-DUMPING MALAM'],
  'EAP REFRESH & COACHING COUNSELING': ['REFRESH & COACHING COUNSELING'],
  'EAP LHD SIANG': ['EVALUASI LHD SIANG'],
  'EAP LHD MALAM': ['EVALUASI LHD MALAM'],
  'ORIENTASI MALAM': ['-'],
  'ORIENTASI UNIT LAIN': ['-']
};

const classIdMap = {
  "221": "OPPHDT2539",
  "222": "OPPHDT2540",
  "223": "OPPHDT2541",
  "224": "OPPHDT2542",
  "225": "OPPHDT2543",
  "228": "OPPHDT2548"
};

const GAS_URL_MAP = {
  "221": "https://script.google.com/macros/s/AKfycbwOK_v7eeJ2YUPMg0ukK_LTqe3Cdqi-7oHYoYMs5r4-dET42gNiQO0EtiFmQ4tvxChrbw/exec",
  "222": "https://script.google.com/macros/s/AKfycbyAPwFyRY2fczQPKmZjiX5sQFqSKF27QiE90NtYxChUx3abVaJkCiP53kSxqPjQuWz4wQ/exec",
  "223": "https://script.google.com/macros/s/AKfycbyvw1cCWP8MTQxK-WBYZsnqAtE_khSchUs1c8DtD-D3m35_NOWFcgHGHinC385l7llEXQ/exec",
  "224": "https://script.google.com/macros/s/AKfycbwIJM5iUqO9TCHsZYMc5gzunHTIscCQQz5vb4r_S0qQrAk6z31a8r5nJEBL4bt0amDv/exec",
  "225": "https://script.google.com/macros/s/AKfycbxfEgfYYQrazu2aFcrkOe5c6UXbHrCa8nr02WmBoeh8BFXkGTfbSbSvpSPqwve_DknH/exec",
  "228": "https://script.google.com/macros/s/AKfycbzRq-VozwwFnvstUh60k27mxEnXhEZ3fwEGMQZwIWXAtr6Ct1HVg2px7wfR7Z3hiOL3/exec"
};

/* ================== EVENT ================== */
tahapanSelect.addEventListener('change', function () {
  subTahapanSelect.innerHTML = '<option value="" disabled selected hidden>-- Pilih Aktivitas --</option>';
  const list = subTahapanData[this.value];
  if (!list) return subTahapanContainer.classList.add('hidden');

  subTahapanContainer.classList.remove('hidden');
  list.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    subTahapanSelect.appendChild(opt);
  });
});

kelasSelect.addEventListener('change', function () {
  const id = classIdMap[this.value];
  classIdInput.value = id || '';
  classIdContainer.classList.toggle('hidden', !id);
});

/* ================== MODE EDIT ================== */
editBtn.addEventListener('click', () => {
  const kelas = kelasSelect.value;
  const gasUrl = GAS_URL_MAP[kelas];
  if (!gasUrl) return alert('Pilih kelas terlebih dahulu');

  editBtn.disabled = true;
  editBtn.textContent = 'Mengambil...';

  fetch(gasUrl + '?action=getEditable')
    .then(res => res.json())
    .then(data => {
      if (!data.length) return alert('Tidak ada data yang bisa diedit');

      if (data.length === 1) return loadToForm(data[0]);

      editSelector.classList.add('show');
      editList.innerHTML = '<option value="">-- Pilih Data --</option>';

      data.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.row;
        opt.textContent = `${d.nama} | ${d.nrp} | ${d.tipeUnit} | ${d.namaInstruktur} | ${d.tahapanPelatihan}`;
        opt.dataset.data = JSON.stringify(d);
        editList.appendChild(opt);
      });
    });
});

editList.addEventListener('change', function () {
  const selectedOption = this.options[this.selectedIndex];
  const data = JSON.parse(selectedOption.dataset.data);
  loadToForm(data);
  editSelector.classList.remove('show');
});

function loadToForm(d) {
  document.getElementById('nama').value = d.nama || '';
  document.getElementById('nrp').value = d.nrp || '';
  document.getElementById('tipeUnit').value = d.tipeUnit || '';
  document.getElementById('namaInstruktur').value = d.namaInstruktur || '';
  document.getElementById('tahapanPelatihan').value = d.tahapanPelatihan || '';
  document.getElementById('tanggal').value = d.tanggal || '';
  document.getElementById('cnUnit').value = d.cnUnit || '';
  document.getElementById('lokasi').value = d.lokasi || '';
  document.getElementById('hmAwal').value = d.hmAwal || '';
  document.getElementById('hmAkhir').value = d.hmAkhir || '';
  document.getElementById('keterangan').value = d.keterangan || '';
  
  kelasSelect.value = d.kelas || '';
  
  // Trigger tahapan change untuk update sub-tahapan
  if (d.tahapanPelatihan) {
    tahapanSelect.dispatchEvent(new Event('change'));
    setTimeout(() => {
      document.getElementById('subTahapan').value = d.subTahapan || '';
    }, 0);
  }

  isEditMode = true;
  editRow = d.row;

  submitBtn.textContent = 'Update';
  submitBtn.classList.add('btn-yellow');
  editBtn.disabled = true;
  editBtn.textContent = 'Edit Mode Aktif';
}

/* ================== SUBMIT ================== */
form.addEventListener('submit', function (e) {
  e.preventDefault();

  const kelas = kelasSelect.value;
  const gasUrl = GAS_URL_MAP[kelas];
  if (!gasUrl) return alert('Kelas belum dipilih');

  if (!subTahapanSelect.value && !subTahapanContainer.classList.contains('hidden')) {
    return alert('Silahkan pilih Aktivitas!');
  }

  const formData = new FormData(form);
  if (isEditMode) formData.append('row', editRow);

  submitBtn.disabled = true;
  submitBtn.textContent = 'Mengirim...';

  fetch(isEditMode ? gasUrl + '?action=update' : gasUrl, {
    method: 'POST',
    body: formData
  })
  .then(() => {
    alert(isEditMode ? 'Data diperbarui' : 'Data disimpan');
    form.reset();
    isEditMode = false;
    editRow = null;
    submitBtn.textContent = 'Kirim';
    submitBtn.classList.remove('btn-yellow');
    editBtn.textContent = 'Edit';
    learnReset();
  })
  .catch(() => alert('Gagal mengirim'))
  .finally(() => {
    submitBtn.disabled = false;
    editBtn.disabled = false;
  });
});

function learnReset() {
  subTahapanContainer.classList.add('hidden');
  classIdContainer.classList.add('hidden');
  editSelector.classList.remove('show');
}

/* ================== MODAL CLOSE ================== */
document.getElementById('closeEditModal').addEventListener('click', () => {
  editSelector.classList.remove('show');
});

editSelector.addEventListener('click', (e) => {
  if (e.target === editSelector) {
    editSelector.classList.remove('show');
  }
});

/* ================== PWA & SERVICE WORKER ================== */
// Check if PWA is already installed
let isInstalled = false;

// Detect if running as PWA
if (window.navigator.standalone === true) {
  isInstalled = true;
  console.log('âœ… Running as installed PWA');
} else if (window.matchMedia('(display-mode: standalone)').matches) {
  isInstalled = true;
  console.log('âœ… Running as installed PWA (standalone mode)');
}

// Register Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js')
    .then(registration => {
      console.log('âœ… Service Worker registered:', registration);
      return registration.update();
    })
    .catch(err => {
      console.error('âŒ Service Worker registration failed:', err);
    });
}

// Install button - enhanced
let deferredPrompt;
const installBtn = document.getElementById('installBtn');

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  // Show install button hanya jika belum installed
  if (!isInstalled) {
    installBtn.style.display = 'block';
    console.log('ðŸ’¾ Install prompt ready');
  }
});

installBtn.addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    
    if (outcome === 'accepted') {
      console.log('âœ… PWA installed!');
      isInstalled = true;
      installBtn.style.display = 'none';
    }
    
    deferredPrompt = null;
  }
});

// Auto-hide install button jika PWA sudah installed
window.addEventListener('appinstalled', () => {
  console.log('âœ… App installed successfully!');
  isInstalled = true;
  installBtn.style.display = 'none';
});

// Online/Offline detection
const statusIndicator = document.getElementById('statusIndicator');
const offlineNotice = document.getElementById('offlineNotice');

function updateOnlineStatus() {
  const isOnline = navigator.onLine;
  if (isOnline) {
    statusIndicator.classList.remove('offline');
    offlineNotice.classList.remove('show');
  } else {
    statusIndicator.classList.add('offline');
    offlineNotice.classList.add('show');
  }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);
updateOnlineStatus();
</script>

</body>
</html>