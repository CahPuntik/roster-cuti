<!DOCTYPE html>

<html lang="id">

<head>

    <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <meta name="description" content="Roster Cuti - Web App untuk data cuti instruktur Admo">

  <meta name="theme-color" content="#00384d">

  <meta name="color-scheme" content="light dark">

  

  <!-- PWA Meta Tags -->

  <meta name="apple-mobile-web-app-capable" content="yes">

  <meta name="mobile-web-app-capable" content="yes">

  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <meta name="apple-mobile-web-app-title" content="Roster Cuti">

  

  <!-- Manifest -->

  <link rel="manifest" href="./manifest.json">

  

  <!-- Icons -->

  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">

  <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png">

  <link rel="apple-touch-icon" href="./icons/icon-192.png">

    

    <title>Roster Cuti</title>

    <style>

        * {

            margin: 0;

            padding: 0;

            box-sizing: border-box;

        }



        body {

            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

            background: linear-gradient(135deg, #2e687bff, #00384d, #002b3d);

            color: #fff;

            min-height: 100vh;

            position: relative;

            overflow-x: hidden;

        }



        .background-image {

            position: fixed; /* fixed to viewport so it always stays at bottom-left */

            left: 0;

            bottom: 0;

            width: 250px;

            height: 250px;

            opacity: 0.45;

            pointer-events: none;

            background-image: url('icons/efek2.png');

            background-position: left bottom;

            background-repeat: no-repeat;

            background-size: contain;

            z-index: 0;

        }



        .container {

            padding: 20px;

            max-width: 1200px;

            margin: 0 auto;

            position: relative; /* ensure stacking above fixed background */

            z-index: 1;

        }



        .title {

            font-size: 24px;

            font-weight: bold;

            text-align: left;

            margin-bottom: 20px;

            color: #ffffff;

        }



        .header-row {

            display: flex;

            align-items: center;

            justify-content: space-between;

            gap: 12px;

            margin-bottom: 12px;

        }



        /* Align title vertically within header-row */

        .header-row .title {

            margin-bottom: 0;

            line-height: 1;

        }



        .action-group {

            display: flex;

            gap: 10px;

            align-items: center;

        }



        .calendar-section {

            margin-bottom: 20px;

            touch-action: pan-y;

        }



        .header {

            display: flex;

            align-items: center;

            background-color: #3A95C9;

            padding: 20px;

            border-top-left-radius: 12px;

            border-top-right-radius: 12px;

            margin: 0 15px;

        }



        .nav-btn {

            background: none;

            border: none;

            color: #fff;

            font-size: 24px;

            cursor: pointer;

            padding: 10px;

            border-radius: 50%;

            transition: background-color 0.2s;

        }



        .nav-btn:hover {

            background-color: rgba(255, 255, 255, 0.2);

        }



        .header-left {

            display: flex;

            flex-direction: column;

            align-items: center;

        }



        .day-big {

            font-size: 48px;

            color: #fff;

            font-weight: bold;

        }



        .day-small {

            font-size: 12px;

            color: #fff;

            margin-top: -5px;

        }



        .divider {

            width: 2px;

            height: 60px;

            background-color: rgba(255,255,255,0.5);

            margin: 0 20px;

        }



        .header-right {

            display: flex;

            flex-direction: column;

            align-items: flex-start;

            flex: 1;

        }



        .month-year {

            font-size: 24px;

            color: #fff;

            font-weight: bold;

        }



        .year-text {

            font-size: 18px;

            color: #e6f3ff;

            font-weight: 600;

        }



        .holiday-info {

            margin-top: 6px;

        }



        .holiday-text {

            font-size: 10px;

            color: #e0f2fe;

            font-weight: 500;

            line-height: 14px;

        }



        .holiday-text.libur {

            color: #a5f3fc;

        }



        .holiday-text.nasional {

            color: orange;

        }



        .calendar-container {

            background-color: #fff;

            margin: 0 15px;

            border-bottom-left-radius: 12px;

            border-bottom-right-radius: 12px;

            padding: 10px;

            box-shadow: 0 5px 15px rgba(0,0,0,0.2);

        }



        .day-labels-row {

            display: flex;

            justify-content: space-between;

            margin-bottom: 8px;

            padding: 0 2px;

        }



        .day-label {

            width: 14.28%;

            text-align: center;

            font-weight: 700;

            font-size: 12px;

            color: #333;

        }



        .day-label.sunday {

            color: #d32f2f;

        }



        .day-label.saturday {

            color: #1e88e5;

        }



        .calendar-row {

            display: flex;

            justify-content: space-between;

            margin-bottom: 8px;

        }



        .day-cell {

            width: 14.28%;

            padding: 8px 4px;

            display: flex;

            flex-direction: column;

            align-items: center;

            border-radius: 8px;

            cursor: pointer;

            transition: background-color 0.2s;

        }



        .day-cell:hover {

            background-color: rgba(58, 149, 201, 0.1);

        }



        .day-cell.leave {

            background-color: #D1FAE5;

        }



        .day-cell.today {

            border: 2px solid #000000;

        }



        .day-number {

            font-weight: bold;

            color: #333;

            font-size: 14px;

            position: relative;

        }



        .note-badge {

            position: absolute;

            top: 2px;

            right: 2px;

            width: 6px;

            height: 6px;

            border-radius: 50%;

            background-color: #FF6B6B;

        }



        .javanese-name {

            font-size: 8px;

            color: #666;

            margin-top: 2px;

            font-weight: 500;

        }



        .dropdown {

            display: flex;

            justify-content: space-between;

            align-items: center;

            background-color: #ffffff;

            padding: 12px 14px;

            border-radius: 10px;

            margin: 0 auto 15px;

            width: 98%;

            cursor: pointer;

        }



        .dropdown-indicator {

            width: 10px;

            height: 10px;

            border-radius: 50%;

            background-color: #3B82F6;

            margin-right: 10px;

        }



        .dropdown-text {

            font-size: 14px;

            color: #111827;

            font-weight: 600;

        }



        .dropdown-arrow {

            font-size: 12px;

            color: #374151;

        }



        .section-title {

            font-size: 18px;

            font-weight: bold;

            color: #fff;

            margin: 0 20px 10px;

        }



        .cuti-list {

            max-height: 400px;

            overflow-y: auto;

            padding: 0 20px;

        }



        .cuti-card {

            background-color: #ffffff;

            padding: 15px;

            border-radius: 12px;

            margin-bottom: 10px;

            box-shadow: 0 2px 8px rgba(0,0,0,0.1);

        }



        .cuti-nama {

            font-size: 16px;

            font-weight: bold;

            color: #333;

            margin-bottom: 10px;

            border-bottom: 1px solid #ddd;

            padding-bottom: 8px;

        }



        .cuti-detail-row {

            display: flex;

            justify-content: space-between;

            margin-bottom: 8px;

        }



        .cuti-label {

            font-size: 14px;

            color: #666;

            font-weight: 600;

            width: 30%;

        }



        .cuti-value {

            font-size: 14px;

            color: #333;

            flex: 1;

            text-align: right;

        }



        .periode-text {

            margin-top: 6px;

            color: #3A95C9;

            font-size: 12px;

            font-weight: 600;

        }



        .empty-text {

            font-size: 16px;

            color: #ccc;

            font-weight: 500;

            text-align: center;

            margin: 40px 0;

        }



        .loading-text {

            font-size: 16px;

            color: #ccc;

            font-weight: 500;

            text-align: center;

            margin: 40px 0;

        }



        /* Modal Styles */

        .modal-overlay {

            position: fixed;

            top: 0;

            left: 0;

            right: 0;

            bottom: 0;

            background-color: rgba(0,0,0,0.4);

            display: flex;

            justify-content: center;

            align-items: center;

            z-index: 1000;

        }



        .modal-box {

            width: 85%;

            max-width: 400px;

            background-color: #333842;

            border-radius: 12px;

            padding: 16px;

        }



        .modal-title {

            font-size: 16px;

            font-weight: bold;

            margin-bottom: 10px;

            color: #fff;

        }



        .saved-notes-container {

            margin-top: 12px;

            padding-top: 12px;

            border-top: 1px solid #555;

        }



        .saved-notes-title {

            font-size: 12px;

            font-weight: 700;

            color: #fff;

            margin-bottom: 8px;

        }



        .saved-notes-list {

            max-height: 150px;

            overflow-y: auto;

        }



        .saved-note-item {

            background-color: rgba(255,255,255,0.1);

            border-radius: 6px;

            padding: 10px;

            margin-bottom: 6px;

            border-left: 3px solid #3A95C9;

            cursor: pointer;

        }



        .saved-note-item:hover {

            background-color: rgba(255,255,255,0.2);

        }



        .saved-note-date {

            font-size: 11px;

            color: #9CA3AF;

            margin-bottom: 4px;

        }



        .saved-note-text {

            font-size: 12px;

            color: #fff;

        }



        .note-input {

            width: 100%;

            height: 80px;

            border: 1px solid #fff;

            border-radius: 8px;

            padding: 8px;

            background-color: transparent;

            color: #fff;

            font-family: inherit;

            resize: vertical;

        }



        .note-input::placeholder {

            color: #999;

        }



        .modal-actions {

            display: flex;

            justify-content: flex-end;

            margin-top: 12px;

        }



        .cancel-btn, .save-btn {

            padding: 10px 16px;

            border-radius: 6px;

            font-weight: 600;

            cursor: pointer;

            border: none;

            color: #fff;

        }



        .cancel-btn {

            background-color: transparent;

            margin-right: 10px;

        }



        .save-btn {

            background-color: #3A95C9;

        }



        .menu-overlay {

            position: fixed;

            left: 15%;

            right: 15%;

            bottom: 100px;

            background-color: #2a2e37;

            border-radius: 10px;

            overflow: hidden;

            box-shadow: 0 5px 15px rgba(0,0,0,0.3);

            z-index: 1001;

        }



        .menu-box {

            border-radius: 10px;

        }



        .menu-item {

            padding: 14px 16px;

            border-bottom: 1px solid #444;

            cursor: pointer;

            text-align: center;

        }



        .menu-item:last-child {

            border-bottom: none;

        }



        .menu-item:hover {

            background-color: rgba(58, 149, 201, 0.1);

        }



        .menu-item.delete {

            color: #ff6b6b;

        }



        .menu-item-text {

            font-size: 14px;

            font-weight: 600;

            color: #3A95C9;

        }



        .menu-backdrop {

            position: fixed;

            top: 0;

            left: 0;

            right: 0;

            bottom: 0;

            z-index: 999;

        }



        .dropdown-overlay {

            position: fixed;

            top: 0;

            left: 0;

            right: 0;

            bottom: 0;

            background-color: rgba(0,0,0,0.4);

            display: flex;

            justify-content: center;

            align-items: center;

            z-index: 1000;

        }



        .action-btn {

            background-color: #3A95C9;

            color: #fff;

            border: none;

            padding: 8px 12px;

            border-radius: 8px;

            font-weight: 600;

            cursor: pointer;

            margin-right: 8px;

            display: inline-flex;

            align-items: center;

            justify-content: center;

        }

        

        .cuti-status {

            margin: 10px 15px;

            padding: 10px 12px;

            border-radius: 10px;

            background: #e5fff0;

            color: #065f46;

            font-weight: 700;

            font-size: 14px;

            border: 2px dashed #4caf50;

          }



        @media (max-width: 480px) {

            .action-btn {

                padding: 6px 8px;

                border-radius: 6px;

            }

        }



        .dropdown-menu {

            width: 70%;

            max-width: 300px;

            background-color: #fff;

            border-radius: 12px;

            padding: 8px 0;

        }



        .dropdown-header {

            padding: 12px 14px 8px;

            border-bottom: 1px solid #E5E7EB;

            display: flex;

            justify-content: space-between;

            align-items: center;

        }



        .dropdown-title {

            font-size: 16px;

            font-weight: 700;

            color: #111827;

        }



        .search-input {

            margin: 10px;

            background-color: #F3F4F6;

            padding: 8px 12px;

            border-radius: 8px;

            border: none;

            color: #111827;

            font-family: inherit;

        }



        .dropdown-list {

            max-height: 220px;

            overflow-y: auto;

        }



        .dropdown-item {

            padding: 12px 16px;

            cursor: pointer;

            display: flex;

            justify-content: space-between;

            align-items: center;

        }



        .dropdown-item:hover {

            background-color: #F3F4F6;

        }



        .dropdown-item.selected {

            background-color: #ECFEFF;

        }



        .dropdown-item-text {

            font-size: 14px;

            color: #111827;

        }



        .dropdown-item.selected .dropdown-item-text {

            font-weight: 700;

            color: #0EA5E9;

        }



        .checkmark {

            font-size: 16px;

            color: #0EA5E9;

        }



        /* Responsive */

        @media (max-width: 768px) {

            .container {

                padding: 8px;

            }



            .title {

                font-size: 20px;

            }



            .header {

                padding: 15px;

                margin: 0 10px;

            }



            /* Hide month navigation buttons on small screens (HP) */

            .nav-btn {

                display: none;

            }



            .day-big {

                font-size: 36px;

            }



            .month-year {

                font-size: 20px;

            }



            .calendar-container {

                margin: 0 10px;

            }



            .dropdown {

                width: 95%;

            }



            .cuti-list {

                padding: 0 10px;

            }



            /* Reduce background image size on small screens */

            .background-image {

                width: 150px;

                height: 150px;

                opacity: 0.25;

                background-size: contain;

                left: 0;

                bottom: 0;

            }

        }

    </style>

</head>

<body>

    <div class="background-image" aria-hidden="true"></div>



    <div class="container">

        <div class="header-row">

            <h1 class="title">Roster Cuti</h1>

            <div class="action-group">

                <button id="installBtn" class="action-btn" style="display:none;">Pasang Aplikasi</button>

            </div>

        </div>

        <div class="calendar-section" id="calendarSection">

            <div class="header" id="calendarHeader">

                <!-- Header content will be populated by JS -->

            </div>

            <div class="calendar-container" id="calendarContainer">

                <!-- Calendar content will be populated by JS -->

            </div>

            <div id="cutiStatusBox" class="cuti-status">

              Sedang Cuti: -

            </div>

        </div>



        <div class="dropdown" id="instrukturDropdown">

            <div style="display: flex; align-items: center;">

                <div class="dropdown-indicator"></div>

                <span class="dropdown-text" id="selectedInstruktur">All Instruktur</span>

            </div>

            <span class="dropdown-arrow">▾</span>

        </div>



        <h2 class="section-title">Jadwal Cuti</h2>

        <div class="cuti-list" id="cutiList">

            <div class="loading-text">Memuat data cuti...</div>

        </div>

    </div>



    <!-- Note Modal -->

    <div class="modal-overlay" id="noteModal" style="display: none;">

        <div class="modal-box">

            <div class="modal-title" id="modalTitle">Catatan</div>

            <div class="saved-notes-container" id="savedNotesContainer" style="display: none;">

                <div class="saved-notes-title">Catatan Tersimpan:</div>

                <div class="saved-notes-list" id="savedNotesList"></div>

            </div>

            <textarea class="note-input" id="noteInput" placeholder="Tulis catatan..."></textarea>

            <div class="modal-actions">

                <button class="cancel-btn" id="cancelBtn">Batal</button>

                <button class="save-btn" id="saveBtn">Simpan</button>

            </div>

        </div>

    </div>



    <!-- Note Menu -->

    <div class="menu-overlay" id="noteMenu" style="display: none;">

        <div class="menu-box">

            <div class="menu-item" id="editNoteBtn">

                <span class="menu-item-text">Edit</span>

            </div>

            <div class="menu-item delete" id="deleteNoteBtn">

                <span class="menu-item-text" style="color: #ff6b6b;">Hapus</span>

            </div>

        </div>

    </div>



    <!-- Menu Backdrop -->

    <div class="menu-backdrop" id="menuBackdrop" style="display: none;"></div>



    <!-- Dropdown Modal -->

    <div class="dropdown-overlay" id="dropdownModal" style="display: none;">

        <div class="dropdown-menu">

            <div class="dropdown-header">

                <span class="dropdown-title">Pilih Instruktur</span>

                <span style="color: #6B7280;" id="instrukturCount"></span>

            </div>

            <input type="text" class="search-input" id="searchInput" placeholder="Cari instruktur...">

            <div class="dropdown-list" id="dropdownList"></div>

        </div>

    </div>



    <script>

        // Javanese day names (Pasaran Jawa)

        const JAVANESE_DAYS = ['Legi', 'Pahing', 'Pon', 'Wage', 'Kliwon'];



        // Function to get Javanese day name based on date

        const getJavaneseDayName = (date) => {

            const epoch = new Date(1945, 7, 17);

            const daysDiff = Math.floor((date.getTime() - epoch.getTime()) / 86400000);

            const index = ((daysDiff % 5) + 5) % 5;

            return JAVANESE_DAYS[index];

        };



        const formatShortDate = (date) => {

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];

            const d = date.getDate();

            const m = months[date.getMonth()];

            const y = date.getFullYear().toString().slice(-2);

            return `${d}-${m}-${y}`;

        };



        const islamicMonths = [

            'Muharram', 'Safar', 'Rabiul Awal', 'Rabiul Akhir', 'Jumadil Awal', 'Jumadil Akhir',

            'Rajab', "Sya'ban", 'Ramadhan', 'Syawal', "Dzulqa'dah", 'Dzulhijjah'

        ];



        // Function to convert Gregorian to Islamic calendar (simple approximation)

        const getIslamicDate = (date) => {

            const jd = Math.floor(date.getTime() / 86400000 + 2440587.5);

            const l = jd + 68569;

            const n = Math.floor((4 * l) / 146097);

            const l2 = l - Math.floor((146097 * n + 3) / 4);

            const i = Math.floor((4000 * (l2 + 1)) / 1461001);

            const l3 = l2 - Math.floor((1461 * i) / 4) + 31;

            const j = Math.floor((80 * l3) / 2447);

            const day = l3 - Math.floor((2447 * j) / 80);

            const l4 = Math.floor(j / 11);

            const month = j + 2 - 12 * l4;



            const jd2 = jd - 1948440;

            const n2 = Math.floor((jd2 / 10631.0) * 30.0);

            const q = jd2 - Math.floor((10631.0 * n2) / 30.0);

            const m = Math.floor((q + 1) / 29.5001);

            const islamicDay = q - Math.floor(29.5001 * m) + 1;

            const islamicMonth = m;

            const islamicYear = Math.floor(n2 + 1);



            return {

                day: Math.floor(islamicDay),

                month: islamicMonth,

                year: islamicYear,

            };

        };



        // Convert Western digits to Arabic-Indic

        const toArabicIndic = (input) => {

            const map = {

                '0': '٠', '1': '١', '2': '٢', '3': '٣', '4': '٤',

                '5': '٥', '6': '٦', '7': '٧', '8': '٨', '9': '٩'

            };

            return String(input).replace(/\d/g, d => map[d] || d);

        };



        // Helper function to get local date in ISO format

        const getLocalISODate = (date) => {

            const year = date.getFullYear();

            const month = String(date.getMonth() + 1).padStart(2, '0');

            const day = String(date.getDate()).padStart(2, '0');

            return `${year}-${month}-${day}`;

        };



        const parseSpreadsheetDate = (input) => {

            if (!input && input !== '0') return null;

            let str = String(input).trim();

            if (str.includes(' ')) str = str.split(' ')[0];

            str = str.replace(/\//g, '-');



            const dNative = new Date(str);

            if (!Number.isNaN(dNative.getTime())) return dNative;



            const months = {

                jan: 0, feb: 1, mar: 2, apr: 3, mei: 4, jun: 5, jul: 6, agu: 7, aug: 7,

                sep: 8, okt: 9, oct: 9, nov: 10, des: 11, dec: 11, january: 0, february: 1,

                march: 2, april: 3, may: 4, june: 5, july: 6, august: 7, september: 8,

                october: 9, november: 10, december: 11,

            };



            const parts = str.includes('-') ? str.split('-') : str.split(/\s+/);

            if (parts.length >= 3) {

                let [dRaw, mRaw, yRaw] = parts.map(p => p.trim());

                let month = months[mRaw.toLowerCase()];

                if (month === undefined) {

                    const key = mRaw.slice(0, 3).toLowerCase();

                    month = months[key];

                }

                const day = Number(dRaw);

                let year = Number(yRaw);

                if (!isNaN(year) && yRaw.length === 2) year = 2000 + year;

                if (!Number.isNaN(day) && month !== undefined && !Number.isNaN(year)) {

                    const dt = new Date(year, month, day);

                    if (!Number.isNaN(dt.getTime())) return dt;

                }

            }



            const num = Number(str);

            if (!Number.isNaN(num) && num > 0) {

                const excelEpoch = new Date(1899, 11, 30);

                const dt = new Date(excelEpoch.getTime() + Math.round(num) * 86400000);

                if (!Number.isNaN(dt.getTime())) return dt;

            }

            return null;

        };



        // Holiday definitions

        const HOLIDAYS = {

            0: [

                { day: 1, name: 'Tahun Baru Masehi', type: 'libur' },

                { day: 16, name: "Isra Mi'raj Nabi Muhammad SAW", type: 'libur' },

                { day: 25, name: 'Hari Gizi Nasional', type: 'nasional' },

            ],

            1: [

                { day: 9, name: 'Hari Pers Nasional', type: 'nasional' },

                { day: 14, name: 'Hari Valentine', type: 'nasional' },

                { day: 16, name: 'Cuti bersama Tahun Baru Imlek', type: 'libur' },

                { day: 17, name: 'Tahun Baru Imlek 2577 Kongzili', type: 'libur' },

            ],

            2: [

                { day: 17, name: 'Hari Perawat Nasional', type: 'nasional' },

                { day: 18, name: 'Cuti bersama Hari Suci Nyepi', type: 'libur' },

                { day: 19, name: 'Hari Suci Nyepi (Tahun Baru Saka 1948)', type: 'libur' },

                { day: 21, name: 'Idhul Fitri 1477 Hijriah', type: 'libur' },

                { day: 22, name: 'Idhul Fitri 1477 Hijriah', type: 'libur' },

                { day: 20, name: 'Cuti bersama Hari Raya Idhul Fitri', type: 'libur' },

                { day: 23, name: 'Cuti bersama Hari Raya Idhul Fitri', type: 'libur' },

                { day: 24, name: 'Cuti bersama Hari Raya Idhul Fitri', type: 'libur' },

            ],

            3: [

                { day: 3, name: 'Wafat Yesus Kristus', type: 'libur' },

                { day: 5, name: 'Hari Kebangkitan Yesus Kristus (Paskah)', type: 'libur' },

                { day: 21, name: 'Hari Kartini', type: 'nasional' },

                { day: 22, name: 'Hari Bumi', type: 'nasional' },

            ],

            4: [

                { day: 1, name: 'Hari Buruh Internasional', type: 'libur' },

                { day: 2, name: 'Hari Pendidikan Nasional', type: 'nasional' },

                { day: 14, name: 'Kenaikan Yesus Kristus', type: 'libur' },

                { day: 15, name: 'Cuti bersama Kenaikan Yesus Kristus', type: 'libur' },

                { day: 27, name: 'Idhul Adha 1447 Hijriah', type: 'libur' },

                { day: 28, name: 'Cuti bersama Idhul Adha 1447 Hijriah', type: 'libur' },

                { day: 31, name: 'Hari Raya Waisak 2570 BE', type: 'libur' },

            ],

            5: [

                { day: 1, name: 'Hari Lahir Pancasila', type: 'libur' },

                { day: 5, name: 'Hari Lingkungan Hidup Sedunia', type: 'nasional' },

                { day: 16, name: '1 Muharram Tahun Baru Islam 1448 Hijriah', type: 'libur' },

                { day: 26, name: 'Hari Anti Narkoba Sedunia', type: 'nasional' },

            ],

            6: [

                { day: 1, name: 'Hari Bhayangkara (HUT POLRI)', type: 'nasional' },

                { day: 23, name: 'Hari Anak Nasional', type: 'nasional' },

            ],

            7: [

                { day: 12, name: 'Hari UMKM Nasional', type: 'nasional' },

                { day: 14, name: 'Hari Pramuka', type: 'nasional' },

                { day: 17, name: 'Hari Kemerdekaan RI', type: 'libur' },

                { day: 25, name: 'Maulid Nabi Muhammad SAW', type: 'libur' },

            ],

            8: [

                { day: 11, name: 'Hari Radio Republik Indonesia (RRI)', type: 'nasional' },

                { day: 17, name: 'Hari Palang Merah Indonesia (PMI)', type: 'nasional' },

                { day: 24, name: 'Hari Tani Nasional', type: 'nasional' },

            ],

            9: [

                { day: 1, name: 'Hari Kesaktian Pancasila', type: 'nasional' },

                { day: 2, name: 'Hari Batik', type: 'nasional' },

                { day: 5, name: 'Hari Lahir TNI', type: 'nasional' },

                { day: 22, name: 'Hari Santri Nasional', type: 'nasional' },

                { day: 28, name: 'Hari Sumpah Pemuda', type: 'nasional' },

            ],

            10: [

                { day: 10, name: 'Hari Pahlawan', type: 'nasional' },

                { day: 12, name: 'Hari Ayah Nasional', type: 'nasional' },

                { day: 25, name: 'Hari Guru Nasional', type: 'nasional' },

            ],

            11: [

                { day: 22, name: 'Hari Ibu', type: 'nasional' },

                { day: 24, name: 'Cuti bersama Hari Raya Natal', type: 'libur' },

                { day: 25, name: 'Hari Raya Natal', type: 'libur' },

            ],

        };



        const getHolidayInfo = (date) => {

            const month = date.getMonth();

            const day = date.getDate();

            const list = HOLIDAYS[month] || [];

            return list.find(h => h.day === day) || null;

        };



        const getCutiDuration = (instruktur) => {

            if (!instruktur) return 10;

            const name = instruktur.trim().toLowerCase();

            const list14 = ['ryan pamungkas', 'ananto ninggar s.', 'muhammad alif fahreza'];

            const list16 = ['iri saefudin', 'daryanto', 'sunarwoto'];

            if (list14.includes(name)) return 14;

            if (list16.includes(name)) return 16;

            return 10;

        };



        // State variables

        let currentMonth = new Date();

        let selectedInstruktur = 'All Instruktur';

        let cutiSheet = [];

        let loadingSheet = true;

        let savedNotes = [];

        let activeDate = null;

        let editingNoteIdx = null;

        let selectedNoteIdx = null;



        const instrukturList = [

            'All Instruktur', 'ABDUL KODIR', 'ABDUL RAHMAN SIDIK', 'ADLIN ZAID', 'ANANTO NINGGAR S.',

            'ANTON SERSANDI', 'ASEP CAHYADI', 'BUDIMAN', 'DARTO', 'DARYANTO', 'DWI HARIONO',

            'GATOT SETIAWAN', 'HADI SUTARTO', 'HERRY KISWANTO K.', 'INDRA HARAPAN', 'IRI SAEFUDIN',

            'IRWAN', 'IRWANUDDIN', 'KHAIRULLAH MILKAN A', 'KHUMAIDI NOVAL', 'LUQYANA IRBACH',

            'M. ABDIANOOR', 'M. KHOIRUL UMAM', 'M.SYAUKANI', 'MUHAMMAD ALIF FAHREZA', 'MUJIANSYAH',

            'NARYONO', 'NASRULLAH', 'RAHMAT', 'RUDI MARDIANTO', 'RYAN PAMUNGKAS', 'SINTAR',

            'SITI AMINAH', 'SLAMET HERIANTO', 'SOLIHIN ROSADI', 'SUNARWOTO', 'SYAIFUL DAFIT ADI SAPUTRA',

            'TEGUH ARIFIATNA', 'WAHYU UTOMO', 'WAHYUDI', 'YULIAN MUSTOFA'

        ];



        // DOM elements

        const calendarHeader = document.getElementById('calendarHeader');

        const calendarContainer = document.getElementById('calendarContainer');

        const instrukturDropdown = document.getElementById('instrukturDropdown');

        const selectedInstrukturEl = document.getElementById('selectedInstruktur');

        const cutiList = document.getElementById('cutiList');

        const noteModal = document.getElementById('noteModal');

        const modalTitle = document.getElementById('modalTitle');

        const savedNotesContainer = document.getElementById('savedNotesContainer');

        const savedNotesList = document.getElementById('savedNotesList');

        const noteInput = document.getElementById('noteInput');

        const cancelBtn = document.getElementById('cancelBtn');

        const saveBtn = document.getElementById('saveBtn');

        const noteMenu = document.getElementById('noteMenu');

        const editNoteBtn = document.getElementById('editNoteBtn');

        const deleteNoteBtn = document.getElementById('deleteNoteBtn');

        const menuBackdrop = document.getElementById('menuBackdrop');

        const dropdownModal = document.getElementById('dropdownModal');

        const searchInput = document.getElementById('searchInput');

        const dropdownList = document.getElementById('dropdownList');

        const instrukturCount = document.getElementById('instrukturCount');



        // Initialize

        document.addEventListener('DOMContentLoaded', () => {

            loadSelectedInstruktur();

            loadNotesFromStorage();

            loadCutiFromStorage();

            renderCalendar();

            renderCutiList();



            // Event listeners

            instrukturDropdown.addEventListener('click', openDropdown);

            cancelBtn.addEventListener('click', closeNoteModal);

            saveBtn.addEventListener('click', saveNote);

            editNoteBtn.addEventListener('click', editNote);

            deleteNoteBtn.addEventListener('click', deleteNote);

            menuBackdrop.addEventListener('click', closeNoteMenu);

            searchInput.addEventListener('input', filterDropdown);



            // Swipe functionality

            let startX = 0;

            calendarSection.addEventListener('touchstart', (e) => {

                startX = e.touches[0].clientX;

            });

            calendarSection.addEventListener('touchend', (e) => {

                const endX = e.changedTouches[0].clientX;

                const diff = startX - endX;

                if (Math.abs(diff) > 50) {

                    if (diff > 0) {

                        changeMonth(1);

                    } else {

                        changeMonth(-1);

                    }

                }

            });



            // Close modals on outside click

            noteModal.addEventListener('click', (e) => {

                if (e.target === noteModal) closeNoteModal();

            });

            dropdownModal.addEventListener('click', (e) => {

                if (e.target === dropdownModal) closeDropdown();

            });

        });



        // Functions

        function loadSelectedInstruktur() {

            const saved = localStorage.getItem('selectedInstruktur');

            if (saved) {

                selectedInstruktur = saved;

                selectedInstrukturEl.textContent = saved;

            }

        }



        function saveSelectedInstruktur() {

            localStorage.setItem('selectedInstruktur', selectedInstruktur);

        }



        function loadNotesFromStorage() {

            const stored = localStorage.getItem('savedNotes');

            if (stored) {

                savedNotes = JSON.parse(stored).map(note => ({

                    ...note,

                    date: new Date(note.date)

                }));

            }

        }



        function saveNotesToStorage() {

            localStorage.setItem('savedNotes', JSON.stringify(savedNotes));

        }



        function loadCutiFromStorage() {

            const cached = localStorage.getItem('cutiSheet');

            if (cached) {

                cutiSheet = JSON.parse(cached);

                loadingSheet = false;

                renderCutiList();

                return;

            }

            fetchCutiSpreadsheet();

        }



        async function fetchCutiSpreadsheet() {

            try {

                const res = await fetch('https://script.google.com/macros/s/AKfycbz-weoOfzgoTDCIATaSXIAqYAfGOOjc3zbCyEE7NnQHTR3xCQ_YcVkGzwOgHT76I3gFRA/exec');

                const json = await res.json();

                cutiSheet = json;

                localStorage.setItem('cutiSheet', JSON.stringify(json));

                loadingSheet = false;

                renderCutiList();

            } catch (err) {

                console.error('Fetch error:', err);

                loadingSheet = false;

                renderCutiList();

            }

        }



        function renderCalendarHeader() {

            const monthNum = String(currentMonth.getMonth() + 1).padStart(2, '0');

            const monthName = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'][currentMonth.getMonth()];

            const year = currentMonth.getFullYear();



            calendarHeader.innerHTML = `

                <button class="nav-btn" id="prevMonth">&lt;</button>

                <div class="header-left">

                    <div class="day-big">${monthNum}</div>

                    <div class="day-small">(${getIslamicMonth(currentMonth)})</div>

                    <div class="day-small" style="opacity: 0.7; margin-top: 8px;">(${getNextIslamicMonth(currentMonth)})</div>

                </div>

                <div class="divider"></div>

                <div class="header-right">

                    <div class="month-year">${monthName}</div>

                    <div class="year-text">${year}</div>

                    <div class="holiday-info">

                        ${getHolidaysByMonth(currentMonth).map(item => 

                            `<div class="holiday-text ${item.type}">${item.type === 'libur' || item.type === 'nasional' ? '•' : ''} ${item.day} ${item.name}</div>`

                        ).join('')}

                    </div>

                </div>

                <button class="nav-btn" id="nextMonth">&gt;</button>

            `;



            // Add event listeners for navigation buttons

            document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));

            document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));

        }



        function getIslamicMonth(date) {

            try {

                const formatter = new Intl.DateTimeFormat('id-ID-u-ca-islamic', { month: 'numeric' });

                const hijriMonthNumber = Number(formatter.format(date)) - 1;

                return islamicMonths[hijriMonthNumber] || '';

            } catch (e) {

                return '';

            }

        }



        function getNextIslamicMonth(date) {

            try {

                const formatter = new Intl.DateTimeFormat('id-ID-u-ca-islamic', { month: 'numeric' });

                let hijriMonthIndex = Number(formatter.format(date)) - 1;

                hijriMonthIndex = (hijriMonthIndex + 1) % 12;

                return islamicMonths[hijriMonthIndex] || '';

            } catch (e) {

                return '';

            }

        }



        function getHolidaysByMonth(date) {

            const month = date.getMonth();

            return HOLIDAYS[month] || [];

        }



        function renderCalendar() {

            renderCalendarHeader();



            const year = currentMonth.getFullYear();

            const month = currentMonth.getMonth();

            const today = new Date();

            const todayKey = getLocalISODate(today);



            const leaveDateSet = new Set();

            cutiSheet.forEach(item => {

                if (selectedInstruktur !== 'All Instruktur' && item.instruktur?.toLowerCase() !== selectedInstruktur.toLowerCase()) return;

                const start = parseSpreadsheetDate(item.tanggal_mulai);

                if (!start) return;

                const dur = getCutiDuration(item.instruktur);

                for (let i = 0; i < dur; i++) {

                    const d = new Date(start);

                    d.setDate(start.getDate() + i);

                    leaveDateSet.add(getLocalISODate(d));

                }

            });



            const notesDateSet = new Set();

            savedNotes.forEach(note => {

                const noteKey = getLocalISODate(note.date);

                notesDateSet.add(noteKey);

            });



            const firstDay = new Date(year, month, 1).getDay();

            const totalDays = new Date(year, month + 1, 0).getDate();

            const totalSlots = 42;



            let cells = [];

            for (let i = 0; i < firstDay; i++) {

                cells.push(null);

            }

            for (let d = 1; d <= totalDays; d++) {

                cells.push(d);

            }

            while (cells.length < totalSlots) {

                cells.push(null);

            }



            calendarContainer.innerHTML = `

                <div class="day-labels-row">

                    <div class="day-label sunday">Mgg</div>

                    <div class="day-label">Sen</div>

                    <div class="day-label">Sel</div>

                    <div class="day-label">Rab</div>

                    <div class="day-label">Kam</div>

                    <div class="day-label">Jum</div>

                    <div class="day-label saturday">Sab</div>

                </div>

                ${Array.from({ length: 6 }, (_, rowIdx) => `

                    <div class="calendar-row">

                        ${cells.slice(rowIdx * 7, rowIdx * 7 + 7).map((dayNum, idx) => {

                            if (!dayNum) return '<div class="day-cell"></div>';

                            const cellDate = new Date(year, month, dayNum);

                            const key = getLocalISODate(cellDate);

                            const isLeave = leaveDateSet.has(key);

                            const hasNote = notesDateSet.has(key);

                            const isToday = key === todayKey;

                            const javaneseName = getJavaneseDayName(cellDate);

                            const islamic = getIslamicDate(cellDate);

                            const holiday = getHolidayInfo(cellDate);



                            let dayNumberClass = '';

                            let dayNumberColor = '';

                            if (holiday) {

                                if (holiday.type === 'libur' || holiday.type === 'cutiBersama') {

                                    dayNumberColor = 'color: #d32f2f;';

                                } else if (holiday.type === 'nasional') {

                                    dayNumberColor = 'color: #f4511e;';

                                }

                            } else if (isLeave) {

                                dayNumberColor = 'color: #065f46;';

                            } else if (idx === 0) {

                                dayNumberColor = 'color: #d32f2f;';

                            } else if (idx === 6) {

                                dayNumberColor = 'color: #1e88e5;';

                            }



                            let javaneseColor = '';

                            if (holiday && holiday.type === 'nasional') {

                                javaneseColor = 'color: #cca700;';

                            } else if (!holiday && isLeave) {

                                javaneseColor = 'color: #065f46;';

                            }



                            return `

                                <div class="day-cell ${isLeave ? 'leave' : ''} ${isToday ? 'today' : ''}" onclick="onPressDate('${cellDate.toISOString()}')">

                                    <div style="position: relative; width: 100%; display: flex; flex-direction: column; align-items: center;">

                                        <div class="day-number" style="${dayNumberColor}">

                                            ${dayNum}

                                            ${hasNote ? '<div class="note-badge"></div>' : ''}

                                        </div>

                                        <div class="javanese-name" style="${javaneseColor}">

                                            ${toArabicIndic(islamic.day)} ${javaneseName}

                                        </div>

                                    </div>

                                </div>

                            `;

                        }).join('')}

                    </div>

                `).join('')}

            `;

              renderCutiStatusHariIni();

        }



        function onPressDate(dateStr) {

            activeDate = new Date(dateStr);

            noteInput.value = '';

            editingNoteIdx = null;

            renderNoteModal();

            noteModal.style.display = 'flex';

        }



        function renderNoteModal() {

            modalTitle.textContent = `Catatan ${activeDate.toLocaleDateString('id-ID')}`;

            if (savedNotes.length > 0) {

                savedNotesContainer.style.display = 'block';

                savedNotesList.innerHTML = savedNotes.map((note, idx) => `

                    <div class="saved-note-item" onclick="selectNote(${idx})" oncontextmenu="showNoteMenu(${idx}); return false;">

                        <div class="saved-note-date">${note.date.toLocaleDateString('id-ID')}</div>

                        <div class="saved-note-text">${note.text}</div>

                    </div>

                `).join('');

            } else {

                savedNotesContainer.style.display = 'none';

            }

        }



        function selectNote(idx) {

            selectedNoteIdx = idx;

            editingNoteIdx = idx;

            noteInput.value = savedNotes[idx].text;

        }



        function showNoteMenu(idx) {

            selectedNoteIdx = idx;

            noteMenu.style.display = 'block';

            menuBackdrop.style.display = 'block';

        }



        function closeNoteMenu() {

            noteMenu.style.display = 'none';

            menuBackdrop.style.display = 'none';

            selectedNoteIdx = null;

        }



        function editNote() {

            if (selectedNoteIdx !== null) {

                editingNoteIdx = selectedNoteIdx;

                noteInput.value = savedNotes[selectedNoteIdx].text;

                closeNoteMenu();

            }

        }



        function deleteNote() {

            if (selectedNoteIdx !== null) {

                savedNotes.splice(selectedNoteIdx, 1);

                saveNotesToStorage();

                renderCalendar();

                closeNoteMenu();

                renderNoteModal();

            }

        }



        function closeNoteModal() {

            noteModal.style.display = 'none';

            activeDate = null;

            editingNoteIdx = null;

            selectedNoteIdx = null;

        }



        function saveNote() {

            const text = noteInput.value.trim();

            if (editingNoteIdx !== null) {

                savedNotes[editingNoteIdx].text = text;

            } else if (activeDate && text) {

                savedNotes.push({ date: activeDate, text });

            }

            saveNotesToStorage();

            renderCalendar();

            closeNoteModal();

        }



        function changeMonth(offset) {

            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + offset, 1);

            renderCalendar();

        }



        function openDropdown() {

            instrukturCount.textContent = `${instrukturList.length} opsi`;

            renderDropdownList();

            dropdownModal.style.display = 'flex';

        }



        function closeDropdown() {

            dropdownModal.style.display = 'none';

        }



        function renderDropdownList() {

            const filtered = instrukturList.filter(item =>

                item.toLowerCase().includes(searchInput.value.toLowerCase())

            );

            dropdownList.innerHTML = filtered.map(item => `

                <div class="dropdown-item ${item === selectedInstruktur ? 'selected' : ''}" onclick="selectInstruktur('${item}')">

                    <span class="dropdown-item-text">${item}</span>

                    ${item === selectedInstruktur ? '<span class="checkmark">✓</span>' : ''}

                </div>

            `).join('');

        }



        function selectInstruktur(item) {

            selectedInstruktur = item;

            selectedInstrukturEl.textContent = item;

            saveSelectedInstruktur();

            closeDropdown();

            renderCalendar();

            renderCutiList();

        }



        function filterDropdown() {

            renderDropdownList();

        }



        function renderCutiList() {

            if (loadingSheet) {

                cutiList.innerHTML = '<div class="loading-text">Memuat data cuti...</div>';

                return;

            }



            const filtered = cutiSheet.filter(item => {

                if (selectedInstruktur === 'All Instruktur') return true;

                return item.instruktur?.toLowerCase() === selectedInstruktur.toLowerCase();

            });

            

            const sortedCuti = [...filtered].sort((a, b) => {

            const aPast = isCutiSudahLewat(a);

            const bPast = isCutiSudahLewat(b);

        

            // Yang belum lewat di atas, yang sudah lewat di bawah

            if (aPast !== bPast) {

                return aPast ? 1 : -1;

            }

        

            // Kalau sama-sama (dua-duanya lewat atau dua-duanya belum),

            // urutkan berdasarkan tanggal mulai

            const aDate = parseSpreadsheetDate(a.tanggal_mulai);

            const bDate = parseSpreadsheetDate(b.tanggal_mulai);

        

            if (!aDate || !bDate) return 0;

            return aDate - bDate;

        });



            if (filtered.length === 0) {

                cutiList.innerHTML = `<div class="empty-text">Tidak ada data cuti (Total: ${cutiSheet.length})</div>`;

                return;

            }



            const periodMap = new Map();

            filtered.forEach(item => {

                const parsed = parseSpreadsheetDate(item.tanggal_mulai);

                if (parsed) {

                    const key = getLocalISODate(parsed);

                    if (!periodMap.has(key)) {

                        periodMap.set(key, periodMap.size + 1);

                    }

                }

            });



            cutiList.innerHTML = sortedCuti.map(item => {

                const startDate = parseSpreadsheetDate(item.tanggal_mulai);

                if (!startDate) return '';

                const duration = getCutiDuration(item.instruktur);

                const endDate = new Date(startDate);

                endDate.setDate(startDate.getDate() + duration - 1);

                const period = periodMap.get(getLocalISODate(startDate)) || 0;



                return `

                    <div class="cuti-card">

                        <div class="cuti-nama">${item.instruktur}</div>

                        <div class="cuti-detail-row">

                            <span class="cuti-label">Periode</span>

                            <span class="cuti-value">${formatShortDate(startDate)} s/d ${formatShortDate(endDate)}</span>

                        </div>

                        <div class="cuti-detail-row">

                            <span class="cuti-label">Durasi</span>

                            <span class="cuti-value">${duration} hari</span>

                        </div>

                        <div class="periode-text">Periode ${period}</div>

                    </div>

                `;

            }).join('');

        }



        // --- PWA: install prompt & SW registration ---

        let deferredPrompt = null;

        const installBtn = document.getElementById('installBtn');



        window.addEventListener('beforeinstallprompt', (e) => {

            e.preventDefault();

            deferredPrompt = e;

            if (installBtn) installBtn.style.display = 'inline-block';

        });



        installBtn?.addEventListener('click', async () => {

            if (!deferredPrompt) return;

            deferredPrompt.prompt();

            const choice = await deferredPrompt.userChoice;

            if (choice.outcome === 'accepted') {

                console.log('App installed');

            }

            deferredPrompt = null;

            installBtn.style.display = 'none';

        });



        // Register service worker

        if ('serviceWorker' in navigator) {

            navigator.serviceWorker.register('./sw.js').then(reg => {

                console.log('Service Worker registered', reg);

            }).catch(err => console.error('SW register failed', err));

        }



        // Hide install button if already installed (display-mode) or when appinstalled event fires

        if ((window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || navigator.standalone === true) {

            installBtn && (installBtn.style.display = 'none');

        }

        window.addEventListener('appinstalled', () => {

            installBtn && (installBtn.style.display = 'none');

            deferredPrompt = null;

        });

        

        function renderCutiStatusHariIni() {

        const box = document.getElementById("cutiStatusBox");

        if (!box) return;

    

        if (loadingSheet || !Array.isArray(cutiSheet)) {

            box.textContent = "Sedang Cuti: -";

            return;

        }

    

        const today = new Date();

        const todayKey = getLocalISODate(today);

    

        const sedangCutiSet = new Set();

    

        cutiSheet.forEach(item => {

            const start = parseSpreadsheetDate(item.tanggal_mulai);

            if (!start || !item.instruktur) return;

    

            const dur = getCutiDuration(item.instruktur);

            for (let i = 0; i < dur; i++) {

                const d = new Date(start);

                d.setDate(start.getDate() + i);

                if (getLocalISODate(d) === todayKey) {

                    sedangCutiSet.add(item.instruktur);

                }

            }

        });

    

        if (sedangCutiSet.size === 0) {

            box.textContent = "Sedang Cuti: -";

        } else {

            const singkatanList = Array.from(sedangCutiSet).map(nama => singkatNama(nama));

              box.textContent = "Sedang Cuti : " + singkatanList.join(", ");

        }

    }

    

    function singkatNama(nama) {

    if (!nama) return "";



    const clean = nama.trim().toUpperCase();



    // 🔴 Pengecualian khusus

    if (clean === "IRWANUDDIN") {

        return "IRN";

    }



    const parts = clean.split(/\s+/);



    // Jika hanya 1 kata → ambil 3 huruf pertama

    if (parts.length === 1) {

        return parts[0].substring(0, 3);

    }



    // Jika 2 kata atau lebih:

    const kata1 = parts[0];

    const kata2 = parts[1];



    const huruf1 = kata1.substring(0, 2);

    const huruf2 = kata2.substring(0, 1);



    return huruf1 + huruf2;

}



    function isCutiSudahLewat(item) {

    const start = parseSpreadsheetDate(item.tanggal_mulai);

    if (!start) return true;



    const dur = getCutiDuration(item.instruktur);

    const end = new Date(start);

    end.setDate(start.getDate() + dur - 1);



    const today = new Date();

    today.setHours(0,0,0,0);



    return end < today; // true kalau sudah lewat

}

    </script>

</body>

</html>



